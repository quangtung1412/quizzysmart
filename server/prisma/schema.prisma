datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  picture   String?
  createdAt DateTime @default(now())
  role      String   @default("user") // 'admin' or 'user'
  bases     KnowledgeBase[]
  attempts  Attempt[]
  assignments TestAssignment[]
}

model KnowledgeBase {
  id        String     @id @default(cuid())
  name      String
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])
  userId    String
  questions Question[]
  attempts  Attempt[]
}

model Question {
  id                String   @id @default(cuid())
  text              String
  options           String   // JSON array string
  correctAnswerIdx  Int
  source            String?
  category          String?
  base              KnowledgeBase @relation(fields: [baseId], references: [id])
  baseId            String
  answers           AttemptAnswer[]
}

model Attempt {
  id             String          @id @default(cuid())
  mode           String
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  score          Float?
  settings       String          // JSON string
  user           User            @relation(fields: [userId], references: [id])
  userId         String
  knowledgeBase  KnowledgeBase?  @relation(fields: [knowledgeBaseId], references: [id])
  knowledgeBaseId String?
  test            Test?           @relation(fields: [testId], references: [id])
  testId          String?
  answers        AttemptAnswer[]
}

model AttemptAnswer {
  id              String   @id @default(cuid())
  selectedIndex   Int?
  isCorrect       Boolean?
  attempt         Attempt  @relation(fields: [attemptId], references: [id])
  attemptId       String
  question        Question @relation(fields: [questionId], references: [id])
  questionId      String
}

model Test {
  id                String           @id @default(cuid())
  name              String
  description       String?
  questionCount     Int              // Total number of questions in the test
  timeLimit         Int              // Time limit in minutes
  maxAttempts       Int              @default(0) // Maximum number of attempts allowed (0 = unlimited)
  startTime         DateTime?        // When users can start taking the test
  endTime           DateTime?        // When the test expires
  knowledgeSources  String           // JSON string: array of {knowledgeBaseId, percentage}
  questionOrder     String           // JSON string array of question IDs (generated randomly)
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  attempts          Attempt[]
  assignments       TestAssignment[]
  
  // Remove the single knowledge base relation since we now support multiple
  @@map("tests")
}

model TestAssignment {
  id         String   @id @default(cuid())
  test       Test     @relation(fields: [testId], references: [id])
  testId     String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  assignedAt DateTime @default(now())
  @@unique([testId, userId])
}